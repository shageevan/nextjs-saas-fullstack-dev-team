# Orchestrator Agent - Operations (Tier 2)
# LOAD ON-DEMAND: Coordination phases, delegation rules, parallel execution
# Estimated tokens: ~800

operations:
  context:
    tier: 2
    estimated_tokens: 800
    load_when: ["orchestrator_active", "coordination_needed"]

  coordination_phases:
    prerequisites:
      description: "Verify all resources and prerequisites before starting"
      participants:
        - Resource Verifier (prerequisites verification)
        - DevOps Engineer (infrastructure setup)
        - Security Expert (secrets configuration)
        - Database Architect (database setup)
      deliverables:
        - Prerequisites verification report
        - MCP server status
        - Environment configuration
        - Readiness report (GO/NO-GO)
      critical: true
      blocking: "Cannot proceed to discovery without GO signal"

    discovery:
      description: "Analyze requirements and determine project scope"
      participants:
        - Product Manager (requirements clarification)
        - Technical Architect (feasibility assessment)
        - UI/UX Designer (user flow analysis)
      deliverables:
        - Clarified requirements
        - Scope definition
        - Risk assessment
        - Technology recommendations
      parallel: true
      estimated_duration: "1 phase"

    planning:
      description: "Create detailed technical plan and architecture"
      participants:
        - Product Manager (PRD creation)
        - Technical Architect (system architecture)
        - Database Architect (multi-tenant strategy)
        - Security Expert (threat modeling)
        - DevOps Engineer (deployment strategy)
      deliverables:
        - Product Requirements Document (PRD)
        - System Architecture Document
        - Database Schema Design
        - Security Assessment
        - Infrastructure Plan
      parallel: true
      estimated_duration: "1-2 phases"

    design:
      description: "Design user experience and component structure"
      participants:
        - UI/UX Designer (Shadcn UI design)
        - Frontend Developer (component planning)
        - Technical Architect (API design)
      deliverables:
        - UI/UX Design with Shadcn components
        - Component hierarchy
        - API contracts
        - State management plan
      parallel: true
      estimated_duration: "1 phase"

    implementation:
      description: "Build the application in coordinated parallel streams"
      parallel_streams:
        infrastructure:
          lead: DevOps Engineer
          tasks:
            - Docker setup
            - CI/CD pipeline
            - Environment configuration
            - Database provisioning
          runs_parallel: true
          blocks_deployment: false

        backend:
          lead: Backend Developer
          participants:
            - Database Architect (schema implementation)
            - Payment Specialist (Stripe integration)
            - Security Expert (auth implementation)
          tasks:
            - API endpoints
            - Business logic
            - Database models
            - Authentication/Authorization
            - Multi-tenant middleware
            - Stripe webhooks
          runs_parallel: true
          handoff_points:
            - "Database schema ready → Backend can implement queries"
            - "Auth design ready → Backend can implement auth"

        frontend:
          lead: Frontend Developer
          participants:
            - UI/UX Designer (component review)
          tasks:
            - Next.js App Router setup
            - Shadcn UI components
            - Server Components
            - Server Actions
            - Client-side state management
            - Responsive layouts
          runs_parallel: true
          handoff_points:
            - "Server Actions ready → Frontend can integrate"
            - "Design ready → Frontend can implement"

        testing:
          lead: QA Engineer
          runs_parallel: true
          continuous: true
          tasks:
            - Unit test setup
            - Integration tests
            - E2E test framework
            - Multi-tenant test isolation
          blocks_deployment: true

      deliverables:
        - Working application
        - Test suite (all passing)
        - Security scan (no critical issues)
        - Documentation

    deployment:
      description: "Deploy to production with monitoring"
      participants:
        - DevOps Engineer (deployment execution)
        - Security Expert (security verification)
        - QA Engineer (smoke tests)
      deliverables:
        - Production deployment
        - Monitoring dashboards
        - Alerting setup
        - Runbook documentation
      critical: true

  delegation_rules:
    authentication:
      primary: Security Expert
      supporting:
        - Backend Developer
        - Frontend Developer
      approval_required: true
      pattern: "Security Expert designs → Backend implements → Frontend integrates"

    multi_tenant_architecture:
      primary: Database Architect
      supporting:
        - Technical Architect
        - Backend Developer
      approval_required: true
      pattern: "DB Architect designs schema → Backend implements queries → Tech Architect reviews"

    stripe_integration:
      primary: Payment Specialist
      supporting:
        - Backend Developer
        - Security Expert
      approval_required: true
      security_review: mandatory
      pattern: "Payment Specialist designs → Backend implements → Security reviews"

    ui_implementation:
      primary: Frontend Developer
      supporting:
        - UI/UX Designer
      approval_required: false
      pattern: "Designer creates specs → Frontend implements"

    api_development:
      primary: Backend Developer
      supporting:
        - Technical Architect
      approval_required: false
      pattern: "Architect designs API → Backend implements"

    infrastructure:
      primary: DevOps Engineer
      supporting:
        - Security Expert
        - Technical Architect
      approval_required: true
      pattern: "Architect plans → DevOps implements → Security reviews"

    database_design:
      primary: Database Architect
      supporting:
        - Technical Architect
        - Backend Developer
      approval_required: true
      pattern: "DB Architect designs → Tech Architect reviews → Backend implements queries"

  parallel_execution:
    core_principle: |
      Agents work SIMULTANEOUSLY until they need each other.
      ONLY block when dependency requires handoff.
      Otherwise, EVERYTHING runs in PARALLEL.

    execution_rules:
      - "If tasks are independent, run them in parallel"
      - "Don't wait unless there's an actual dependency"
      - "Multiple agents can work at the same time"
      - "Only block when handoff is required"
      - "Continue other work while waiting for handoffs"

    dependency_levels:
      level_0_prerequisites:
        agent: Resource Verifier
        blocks: "EVERYTHING"
        rationale: "Cannot start without verified resources"

      level_1_discovery:
        agents: ["Product Manager", "Technical Architect", "UI/UX Designer"]
        parallel: true
        blocks: "Planning phase"

      level_2_planning:
        agents: ["Technical Architect", "Database Architect", "Security Expert", "DevOps Engineer", "Payment Specialist"]
        parallel: true
        blocks: "Implementation phase"

      level_3_implementation:
        streams:
          infrastructure: ["DevOps Engineer"]
          database: ["Database Architect", "Backend Developer"]
          backend: ["Backend Developer", "Security Expert", "Payment Specialist"]
          frontend: ["Frontend Developer", "UI/UX Designer"]
          testing: ["QA Engineer"]
        parallel: true
        handoffs_allowed: true
        blocks: "Deployment"

      level_4_deployment:
        agents: ["DevOps Engineer", "Security Expert", "QA Engineer"]
        parallel: false
        requires_all_complete: true

    handoff_optimization:
      strategy_1_continue_other_work:
        description: "Don't stop when waiting for handoff"
        example: "Frontend needs Backend Server Action → Frontend continues building other components while waiting"

      strategy_2_batch_handoffs:
        description: "Collect multiple needs before handing off"
        example: "Frontend batches all needed Server Actions → Single handoff to Backend → Backend implements all at once"

      strategy_3_async_communication:
        description: "Hand off and keep working, don't wait synchronously"
        example: "Backend hands off auth implementation → Continues building other APIs → Receives auth completion later"

      strategy_4_clear_interfaces:
        description: "Define contracts early so parallel work is possible"
        example: "Architect defines API contracts → Backend builds to contract → Frontend builds to contract → Both work in parallel"

  best_practices_checklist:
    security:
      - "Authentication reviewed by Security Expert"
      - "Authorization (RBAC) implemented correctly"
      - "OWASP Top 10 addressed"
      - "PCI compliance if handling payments"
      - "Tenant isolation verified"

    architecture:
      - "System architecture documented"
      - "ADRs created for major decisions"
      - "API contracts defined"
      - "Error handling strategy in place"
      - "Performance targets defined"

    database:
      - "Multi-tenant strategy chosen and documented"
      - "Schema includes tenantId on all tables"
      - "Indexes on tenantId and foreign keys"
      - "Migrations tested"
      - "Soft deletes implemented"

    payments:
      - "Stripe webhook signature verification"
      - "Idempotency for webhook handlers"
      - "Subscription lifecycle handled"
      - "Failed payment handling"
      - "Customer portal implemented"

    performance:
      - "Database queries optimized"
      - "N+1 queries eliminated"
      - "Caching strategy implemented"
      - "Page load time <3s"
      - "API response time <200ms (p95)"

    testing:
      - "Unit tests for business logic"
      - "Integration tests for APIs"
      - "E2E tests for critical flows"
      - "Multi-tenant test isolation"
      - "Test coverage >80%"

    deployment:
      - "Docker configuration complete"
      - "CI/CD pipeline configured"
      - "Environment variables documented"
      - "Monitoring and alerting setup"
      - "Rollback strategy defined"

  references:
    detailed_examples: "@reference orchestrator/examples/"
    coordination_patterns: "@reference docs/core/PARALLEL-CORE.md"
    role_boundaries_guide: "@reference docs/core/ROLE-BOUNDARIES-CORE.md"
