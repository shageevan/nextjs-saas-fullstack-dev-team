# GUARDRAILS - Security Rules for All Agents
# Enforced by orchestrator and all 12 agents
# Version: 1.0.0
# Status: ACTIVE

version: "1.0.0"
enforced_by:
  - "orchestrator (Kai)"
  - "all 12 agents"
applies_to:
  - "this folder (fullstack/)"
  - "all project folders created by agents"

# =============================================================================
# CRITICAL BLOCKS - Never Allow, No Override
# =============================================================================

critical_blocks:
  file_system_destruction:
    patterns:
      - "rm -rf /(|bin|etc|usr|var|home|opt|boot|lib|sbin|sys|proc)"
      - "rm -rf /.*"
      - "rm -rf \\.\\./\\.\\./.*"
      - "dd if=/dev/(zero|urandom) of=/dev/(sd|hd|nvme).*"
      - "mkfs\\..*"
      - "find / -delete"
      - "find / -exec rm .*"
      - "rm -rf ~/\\..*"
      - "shred -.*"

    message: "ðŸ”´ BLOCKED: File system destruction detected"
    severity: "CRITICAL"
    log: true

  system_modifications:
    patterns:
      - "chmod.*/(etc|var|usr|bin|sbin)/.*"
      - "chown.*/(etc|var|usr|bin|sbin)/.*"
      - "chmod -R 777 /.*"
      - "echo .* > /etc/.*"
      - "sudo visudo"
      - "systemctl (stop|disable) .*"
      - "pkill -9 (systemd|init|sshd)"
      - "export PATH=\"\""
      - "unset PATH"

    message: "ðŸ”´ BLOCKED: System modification detected"
    severity: "CRITICAL"
    log: true

  privilege_escalation:
    patterns:
      - "sudo (su|rm|chmod.*/(etc|var|usr))"
      - "sudo -i"
      - "su root"
      - "su -"
      - "chmod [0-9]*s .*"  # SUID bit

    message: "ðŸ”´ BLOCKED: Privilege escalation attempt"
    severity: "CRITICAL"
    log: true
    alert: true  # Alert user of security concern

  remote_execution:
    patterns:
      - "curl .* \\| (bash|sh)"
      - "wget .* && (bash|sh)"
      - "curl -sSL .* \\| sudo bash"
      - "nc .* \\| bash"
      - "cat /dev/tcp/.* \\| bash"
      - "base64 -d \\| bash"

    message: "ðŸ”´ BLOCKED: Remote code execution attempt"
    severity: "CRITICAL"
    log: true
    alert: true

  secret_exposure:
    patterns:
      - "git add \\.env(\\.local|\\.production)?"
      - "git add (secrets|credentials)\\..*"
      - "git add .*\\.(pem|key)$"
      - "git add id_rsa"
      - "echo \\$.*(_KEY|_SECRET|_PASSWORD|_TOKEN|DATABASE_URL)"
      - "console\\.log\\(process\\.env\\..*(_KEY|_SECRET|_PASSWORD|_TOKEN)\\)"
      - "cp -r \\.git /public/"

    message: "ðŸ”´ BLOCKED: Attempting to expose secrets"
    severity: "CRITICAL"
    log: true
    alert: true

  git_destructive:
    protected_branches:
      - "main"
      - "master"
      - "production"
      - "staging"
      - "release/*"

    patterns:
      - "git push (--force|-f) origin (main|master|production|staging)"
      - "git push origin (--delete|:)(main|master|production|staging)"
      - "git reset --hard origin/(main|master) && git clean"
      - "git filter-branch --force"
      - "git branch \\| xargs git branch -D"

    message: "ðŸ”´ BLOCKED: Destructive git operation on protected branch"
    severity: "CRITICAL"
    log: true

  process_manipulation:
    patterns:
      - ":(\\)){2,}.*"  # Fork bomb pattern
      - "while true; do (yes|fork)"
      - "stress --cpu"
      - "dd if=/dev/zero of=.* bs=1G count=[5-9][0-9]+"
      - "killall -9 -u"
      - "pkill -9 -u"

    message: "ðŸ”´ BLOCKED: Process manipulation / DoS attempt"
    severity: "CRITICAL"
    log: true
    alert: true

  docker_dangerous:
    patterns:
      - "docker run --privileged"
      - "docker run --cap-add=ALL"
      - "docker run -v /:/.*"
      - "docker run -v /etc:/.*"
      - "docker run -v ~/.ssh:/.*"
      - "docker run -v /var/run/docker\\.sock:/.*"
      - "docker (rm|rmi) -f \\$\\(docker (ps|images) -aq\\)"
      - "docker system prune -af --volumes"

    message: "ðŸ”´ BLOCKED: Dangerous Docker operation"
    severity: "CRITICAL"
    log: true

# =============================================================================
# USER CONFIRMATION REQUIRED - Safe Locations Only
# =============================================================================

require_confirmation:
  safe_deletions:
    allowed_paths:
      - "node_modules"
      - ".next"
      - "dist"
      - "build"
      - "coverage"
      - ".cache"
      - ".turbo"
      - "out"

    patterns:
      - "rm -rf (node_modules|\\.next|dist|build|coverage|\\.cache)"

    prompt: "Delete {matched_path}? This will require reinstallation."
    show_size: true
    confirmation_required: true

  git_operations:
    patterns:
      - "git push --force origin (feature|fix|dev)/.*"
      - "git commit --amend"
      - "git branch -D .*"
      - "git stash (drop|clear)"

    prompt: "Confirm git operation: {command}"
    show_impact: true
    confirmation_required: true

  database_operations:
    development_only:
      - "npm run prisma:reset"
      - "npm run db:seed"
      - "npx drizzle-kit push"

    environment_check: true
    block_if_production: true
    prompt: "Run database operation in {environment}?"
    confirmation_required: true

  network_operations:
    patterns:
      - "ssh .*@.*"
      - "scp .* .*@.*:"
      - "nc -l [0-9]+"
      - "python -m http\\.server"

    prompt: "Allow network operation: {command}?"
    show_details: true
    confirmation_required: true

# =============================================================================
# PACKAGE INSTALLATION - Smart Approval System
# =============================================================================

package_installation:
  # Reference external allowlist
  allowlist_file: "PACKAGE-ALLOWLIST.yaml"

  workflow:
    step_1_check_allowlist:
      description: "Check if package in auto-approved list"
      action: "INSTALL (no prompt)"
      applies_to:
        - "auto_approved_packages"
        - "trusted_organizations"
        - "safe_patterns"

    step_2_check_blocklist:
      description: "Check if package in blocklist"
      action: "BLOCK (security risk)"
      message: "ðŸ”´ BLOCKED: Package '{package}' is known to be malicious"

    step_3_security_verification:
      description: "Security Agent (Riley) verification"
      trigger:
        - "package not in allowlist"
        - "package not in blocklist"
      agent: "Riley (Security Expert)"

      checks:
        - name: "npm_registry_check"
          query: "Verify package exists on npm registry"

        - name: "download_statistics"
          query: "Check weekly download count"
          auto_approve_if: ">100,000 downloads/week"
          ask_user_if: "10,000-100,000 downloads/week"
          block_if: "<1,000 downloads/week"

        - name: "last_update_check"
          query: "Check when package was last updated"
          auto_approve_if: "<6 months ago"
          ask_user_if: "6-12 months ago"
          block_if: ">24 months ago"

        - name: "vulnerability_scan"
          query: "Check npm audit for vulnerabilities"
          auto_approve_if: "no high/critical vulnerabilities"
          ask_user_if: "low vulnerabilities only"
          block_if: "high/critical vulnerabilities present"

        - name: "author_verification"
          query: "Check package author reputation"

        - name: "install_scripts"
          query: "Analyze postinstall scripts"
          flag_if: "complex scripts present"

        - name: "typosquatting_check"
          query: "Check if name similar to popular package"
          block_if: "suspected typosquatting"

        - name: "license_check"
          query: "Verify license is open source"
          acceptable_licenses:
            - "MIT"
            - "Apache-2.0"
            - "BSD-3-Clause"
            - "BSD-2-Clause"
            - "ISC"

      security_agent_response:
        format: |
          ðŸ“¦ Package Security Report: {package}@{version}

          âœ… npm Registry: {found/not found}
          ðŸ“Š Downloads: {count}/week
          ðŸ“… Last Updated: {date}
          ðŸ”’ Vulnerabilities: {count} ({severity})
          ðŸ‘¤ Author: {name} ({reputation})
          ðŸ“œ License: {license}
          âš™ï¸ Install Scripts: {analysis}

          Security Score: {score}/10

          Recommendation: {AUTO_APPROVE|ASK_USER|BLOCK}
          {detailed_message}

    step_4_user_prompt:
      trigger:
        - "Security Agent recommends ASK_USER"
        - "Security risk found but not critical"

      prompt_format: |
        ðŸ“¦ Install package: {package}@{version}?

        {security_report}

        Options:
        1. âœ… Install anyway
        2. âŒ Cancel
        3. ðŸ” Find alternative

        Your choice:

      show_alternatives: true
      log_decision: true

  logging:
    log_all_installs: true
    log_blocked_packages: true
    log_user_decisions: true
    log_security_scores: true

# =============================================================================
# CONTEXT-AWARE RULES
# =============================================================================

context_rules:
  production_environment:
    detection:
      - environment_variable: "NODE_ENV=production"
      - branch_name: "main|master|production"
      - database_url_pattern: ".*\\.prod\\..*"

    restrictions:
      - "Block all destructive database operations"
      - "Block database schema changes"
      - "Require explicit confirmation for deployments"
      - "Block experimental features"

  development_environment:
    detection:
      - environment_variable: "NODE_ENV=development"
      - branch_name: "dev|feature/.*|fix/.*"
      - database_url_pattern: ".*\\.dev\\..*|localhost"

    allow:
      - "Database resets with confirmation"
      - "Seed data operations"
      - "Experimental features"
      - "Hot module replacement"

# =============================================================================
# SECURITY AGENT (RILEY) INTEGRATION
# =============================================================================

security_agent_integration:
  agent_name: "Riley (Security Expert)"
  agent_file: "agents/security.agent.yaml"

  responsibilities:
    - "Verify package safety when not in allowlist"
    - "Analyze install scripts for suspicious behavior"
    - "Check npm audit for vulnerabilities"
    - "Verify package author reputation"
    - "Detect typosquatting attempts"
    - "Recommend safe alternatives"

  verification_protocol: |
    When agent encounters unknown package:

    1. Load Riley (Security Expert)
    2. Riley performs security checks
    3. Riley provides security score (0-10)
    4. Riley gives recommendation:
       - AUTO_APPROVE (score >8, all checks pass)
       - ASK_USER (score 5-8, some concerns)
       - BLOCK (score <5, security risks)
    5. If ASK_USER, prompt user with full report
    6. Log decision for future reference

  example_interaction: |
    Orchestrator: "Need to install package 'some-new-lib'"
    Riley: *performs security checks*
    Riley: "Package has 50K downloads/week, last updated 2 months ago,
           no vulnerabilities, MIT license. Author is relatively new.
           Security score: 7.5/10
           Recommendation: ASK_USER"
    Orchestrator: *prompts user*
    User: "Install anyway"
    Orchestrator: "Installing and logging decision"

# =============================================================================
# OVERRIDE MECHANISM (Advanced Users)
# =============================================================================

override_mechanism:
  enabled: false  # Set to true to allow overrides

  # If enabled, user can override MEDIUM severity blocks
  # CRITICAL blocks cannot be overridden

  override_command_format: "OVERRIDE: {command}"

  requires:
    - "Explicit OVERRIDE prefix"
    - "Written explanation"
    - "Confirmation prompt"

  logged: true
  alerts_on_override: true

# =============================================================================
# LOGGING & AUDITING
# =============================================================================

logging:
  enabled: true
  log_file: ".claude-code/logs/guardrails.log"

  log_events:
    - "blocked_command"
    - "approved_command"
    - "user_confirmation"
    - "security_verification"
    - "package_installation"
    - "override_attempt"

  log_format: |
    [{timestamp}] [{severity}] [{agent}] {event_type}
    Command: {command}
    Decision: {approved|blocked|user_confirmed}
    Reason: {reason}
    Security Score: {score} (if applicable)
    ---

  retention: "30 days"
  rotate: true

# =============================================================================
# ALERTS & NOTIFICATIONS
# =============================================================================

alerts:
  enabled: true

  alert_on:
    - "critical_block_attempt"
    - "privilege_escalation_attempt"
    - "secret_exposure_attempt"
    - "remote_execution_attempt"
    - "repeated_override_attempts"

  alert_format: |
    âš ï¸ SECURITY ALERT
    Event: {event_type}
    Severity: {severity}
    Agent: {agent_name}
    Command: {command}
    Time: {timestamp}

# =============================================================================
# EXEMPTIONS (Project-Specific)
# =============================================================================

exemptions:
  # Add project-specific exemptions here if needed
  # Example:
  # custom_scripts:
  #   - "scripts/custom-deploy.sh"
  #   reason: "Approved deployment script"
  #   approved_by: "user@example.com"
  #   date: "2025-01-22"

# =============================================================================
# ENFORCEMENT
# =============================================================================

enforcement:
  pre_execution_check: true
  block_on_pattern_match: true
  require_confirmation_before_destructive: true

  validation_order:
    1: "Check critical_blocks"
    2: "Check context_rules"
    3: "Check require_confirmation"
    4: "Check package_installation (if npm/yarn/pnpm)"
    5: "Execute if all checks pass"

  on_violation:
    action: "BLOCK"
    log: true
    alert: true
    message: "Display to user"
    suggest_alternative: true

# =============================================================================
# TESTING & VALIDATION
# =============================================================================

testing:
  test_mode: false  # Set to true for testing guardrails

  test_commands:
    - "rm -rf /"  # Should block
    - "rm -rf node_modules"  # Should ask confirmation
    - "npm install react"  # Should auto-approve
    - "npm install unknown-sketchy-package"  # Should trigger Security Agent
    - "git push --force origin main"  # Should block
    - "git push --force origin feature/test"  # Should ask confirmation

  expected_results:
    documented: true
    auto_verify: true

# =============================================================================
# VERSION & UPDATES
# =============================================================================

version_info:
  current_version: "1.0.0"
  last_updated: "2025-01-22"
  changelog:
    - version: "1.0.0"
      date: "2025-01-22"
      changes:
        - "Initial guardrails implementation"
        - "117 dangerous commands identified"
        - "Package allowlist with 200+ safe packages"
        - "Security Agent integration"
        - "User confirmation workflow"

  update_schedule: "Review monthly, update as needed"
