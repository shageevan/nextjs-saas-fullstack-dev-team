# Package Allowlist - Auto-Approved Packages
# These packages are verified safe and can be installed without prompting

version: "1.0.0"
last_updated: "2025-01-22"

# Criteria for inclusion:
# 1. Official packages from trusted organizations
# 2. 1M+ weekly downloads on npm
# 3. Active maintenance (updated within 6 months)
# 4. No known security vulnerabilities
# 5. Used in production by major companies

auto_approved_packages:
  # Next.js Ecosystem (Official)
  nextjs:
    - "next"
    - "@next/bundle-analyzer"
    - "@next/env"
    - "@next/font"
    - "@next/mdx"
    - "next-auth"
    - "next-themes"
    - "next-intl"
    - "next-seo"
    - "next-sitemap"

  # React Ecosystem (Official)
  react:
    - "react"
    - "react-dom"
    - "react-hook-form"
    - "react-router-dom"
    - "react-query"
    - "@tanstack/react-query"
    - "react-hot-toast"
    - "react-error-boundary"
    - "react-use"
    - "react-intersection-observer"

  # UI Libraries (Shadcn/Radix)
  ui:
    - "shadcn-ui"
    - "@radix-ui/react-*"  # All Radix UI primitives
    - "tailwindcss"
    - "@tailwindcss/forms"
    - "@tailwindcss/typography"
    - "tailwind-merge"
    - "clsx"
    - "class-variance-authority"
    - "lucide-react"
    - "framer-motion"

  # TypeScript & Build Tools
  typescript:
    - "typescript"
    - "@types/*"  # All DefinitelyTyped packages
    - "ts-node"
    - "tsx"
    - "tsup"
    - "tsconfig-paths"

  # Database & ORM
  database:
    - "prisma"
    - "@prisma/client"
    - "drizzle-orm"
    - "drizzle-kit"
    - "pg"
    - "postgres"
    - "@vercel/postgres"
    - "mysql2"
    - "mongodb"
    - "mongoose"

  # Redis & Caching
  redis:
    - "redis"
    - "ioredis"
    - "@upstash/redis"
    - "@vercel/kv"

  # Authentication
  auth:
    - "next-auth"
    - "@auth/core"
    - "@clerk/nextjs"
    - "@clerk/clerk-react"
    - "jose"
    - "jsonwebtoken"
    - "bcrypt"
    - "bcryptjs"
    - "argon2"

  # Payments (Stripe)
  payments:
    - "stripe"
    - "@stripe/stripe-js"
    - "@stripe/react-stripe-js"

  # Validation & Schema
  validation:
    - "zod"
    - "yup"
    - "joi"
    - "validator"

  # Testing
  testing:
    - "vitest"
    - "@vitest/ui"
    - "@testing-library/react"
    - "@testing-library/jest-dom"
    - "@testing-library/user-event"
    - "playwright"
    - "@playwright/test"
    - "jest"
    - "jest-environment-jsdom"
    - "@types/jest"

  # Linting & Formatting
  code_quality:
    - "eslint"
    - "eslint-config-next"
    - "eslint-config-prettier"
    - "prettier"
    - "prettier-plugin-tailwindcss"
    - "@typescript-eslint/parser"
    - "@typescript-eslint/eslint-plugin"

  # Utility Libraries
  utilities:
    - "lodash"
    - "date-fns"
    - "dayjs"
    - "uuid"
    - "nanoid"
    - "axios"
    - "ky"
    - "dotenv"
    - "cross-env"
    - "rimraf"

  # State Management
  state:
    - "zustand"
    - "jotai"
    - "valtio"
    - "redux"
    - "@reduxjs/toolkit"

  # Forms
  forms:
    - "react-hook-form"
    - "formik"
    - "@hookform/resolvers"

  # Server/API
  server:
    - "express"
    - "cors"
    - "helmet"
    - "compression"
    - "morgan"

  # Environment & Config
  config:
    - "dotenv"
    - "@t3-oss/env-nextjs"
    - "@t3-oss/env-core"

  # Monitoring & Analytics
  monitoring:
    - "@sentry/nextjs"
    - "@vercel/analytics"
    - "@vercel/speed-insights"
    - "posthog-js"

  # Email
  email:
    - "nodemailer"
    - "@sendgrid/mail"
    - "resend"
    - "@react-email/components"

  # File Upload
  files:
    - "multer"
    - "formidable"
    - "uploadthing"
    - "@uploadthing/react"

  # Image Processing
  images:
    - "sharp"
    - "next/image"

  # Markdown & Content
  content:
    - "marked"
    - "remark"
    - "rehype"
    - "gray-matter"
    - "@mdx-js/loader"
    - "@mdx-js/react"

  # i18n
  i18n:
    - "next-intl"
    - "i18next"
    - "react-i18next"

# Essential Development Dependencies (Auto-approved)
essential_dev_dependencies:
  - "typescript"
  - "@types/node"
  - "@types/react"
  - "@types/react-dom"
  - "eslint"
  - "prettier"
  - "tailwindcss"
  - "postcss"
  - "autoprefixer"

# Trusted Organizations (Auto-approve their packages)
trusted_organizations:
  - "@vercel/*"
  - "@next/*"
  - "@radix-ui/*"
  - "@tanstack/*"
  - "@typescript-eslint/*"
  - "@testing-library/*"
  - "@stripe/*"
  - "@clerk/*"
  - "@sentry/*"
  - "@prisma/*"
  - "@upstash/*"
  - "@t3-oss/*"
  - "@hookform/*"
  - "@mdx-js/*"

# Package Patterns (Auto-approve if matches)
safe_patterns:
  - "^@types/.*"          # All TypeScript type definitions
  - "^eslint-.*"          # ESLint plugins and configs
  - "^prettier-.*"        # Prettier plugins
  - "^tailwindcss-.*"     # Tailwind plugins
  - "^postcss-.*"         # PostCSS plugins
  - "^@radix-ui/.*"       # All Radix UI packages
  - "^@tanstack/.*"       # TanStack packages (React Query, etc.)

# Security Verification Required (Not auto-approved)
security_check_required:
  # Packages that need verification
  reasons:
    uncommon_registry: "Package not from npm registry"
    low_downloads: "Package has <100k weekly downloads"
    recent_creation: "Package created within last 3 months"
    no_recent_updates: "Package not updated in 12+ months"
    known_vulnerabilities: "Package has known vulnerabilities"
    suspicious_name: "Package name similar to popular package (typosquatting)"
    complex_install_script: "Package has complex postinstall scripts"

# Blocklist (Never allow - known malicious or risky)
blocklist:
  packages:
    - "event-stream"      # Historical malware incident
    - "flatmap-stream"    # Historical malware incident
    - "eslint-scope"      # Historical compromise

  patterns:
    - ".*-node-serialize.*"  # Known vulnerable patterns
    - ".*bitcoin.*miner.*"   # Crypto mining

# Verification Workflow
verification_workflow:
  step_1_auto_approve:
    check:
      - "Package in auto_approved_packages"
      - "Package matches trusted_organizations"
      - "Package matches safe_patterns"
    action: "INSTALL (no prompt)"

  step_2_blocklist:
    check:
      - "Package in blocklist"
      - "Package matches blocklist patterns"
    action: "BLOCK (security risk)"

  step_3_security_agent:
    trigger:
      - "Package not in allowlist"
      - "Package is new or uncommon"
    action: "Security Agent (Riley) verification"
    checks:
      - "npm registry verification"
      - "Weekly download count (>100k preferred)"
      - "Last update date (within 12 months)"
      - "Known vulnerabilities (npm audit)"
      - "Package author reputation"
      - "Install scripts analysis"
      - "Typosquatting check"
      - "License verification"

  step_4_user_prompt:
    trigger:
      - "Security Agent uncertain"
      - "Security risk found but not critical"
    action: "Prompt user with security report"
    show:
      - "Package name and version"
      - "Weekly downloads"
      - "Last updated date"
      - "Security findings"
      - "Alternative suggestions"
    options:
      - "Install anyway"
      - "Cancel"
      - "Find alternative"

# Security Agent Verification Criteria
security_verification_criteria:
  auto_approve_if:
    - downloads_per_week: ">100,000"
    - last_updated: "<6 months ago"
    - npm_audit_score: "no high/critical vulnerabilities"
    - official_package: "verified by npm"
    - license: "MIT|Apache-2.0|BSD-3-Clause"

  ask_user_if:
    - downloads_per_week: "10,000-100,000"
    - last_updated: "6-12 months ago"
    - npm_audit_score: "low vulnerabilities only"
    - unverified_author: true

  block_if:
    - downloads_per_week: "<1,000"
    - last_updated: ">24 months ago"
    - npm_audit_score: "high/critical vulnerabilities"
    - known_malware: true
    - suspicious_install_scripts: true
    - typosquatting_detected: true

# Example Security Agent Response Format
example_security_report:
  package: "some-new-package"
  version: "1.0.0"
  security_score: 7.5  # 0-10 scale

  checks:
    npm_registry: "✅ Found on npm"
    downloads: "⚠️ 50,000/week (below 100k threshold)"
    last_update: "✅ 2 months ago"
    vulnerabilities: "✅ None found"
    author: "⚠️ New author (account created 6 months ago)"
    license: "✅ MIT"
    install_scripts: "✅ No postinstall scripts"

  recommendation: "ASK_USER"
  message: "Package appears safe but has moderate weekly downloads. Author is relatively new. Recommend reviewing package source before installing."

  alternatives:
    - name: "well-known-alternative"
      downloads: "5M/week"
      note: "More established package with similar functionality"

# Logging
logging:
  log_auto_approved: true
  log_blocked: true
  log_security_checks: true
  log_user_decisions: true

  log_location: ".claude-code/logs/package-security.log"

  log_format: |
    [timestamp] [action] package=name@version security_score=X.X user_decision=approved/rejected
